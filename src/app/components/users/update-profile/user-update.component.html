<section class="flex flex-col items-center mt-6 px-4 w-full max-w-2xl mx-auto">
  <div class="bg-white shadow-lg rounded-lg p-6 w-full">
    <h1 class="text-3xl font-bold mb-6 text-center text-blue-900">Actualizar Perfil</h1>

    <!-- Indicador de carga -->
    <div *ngIf="isLoading" class="text-center text-gray-500">
      Cargando...
    </div>

    <!-- Formulario de actualización -->
    <form *ngIf="!isLoading" (ngSubmit)="saveProfile()" #profileForm="ngForm" class="space-y-6">

      <!-- Nombre de Usuario -->
      <div>
        <label class="block text-lg font-medium text-gray-700">Nombre de Usuario *</label>
        <div class="flex items-center border border-gray-300 rounded-lg shadow-sm focus-within:ring-2 focus-within:ring-blue-500">
          <input
            type="text"
            [(ngModel)]="profile.username"
            name="username"
            required
            minlength="3"
            maxlength="20"
            class="outline-none text-lg w-full px-3 py-2 rounded-l-lg"
            placeholder="Nombre de Usuario"
          />
          <i class="ti ti-user text-2xl px-3 text-gray-500"></i>
        </div>
        <div *ngIf="profileForm.controls['username']?.invalid && profileForm.controls['username']?.touched" class="text-red-500 text-sm mt-1">
          <div *ngIf="profileForm.controls['username']?.errors?.['required']">El nombre de usuario es obligatorio.</div>
          <div *ngIf="profileForm.controls['username']?.errors?.['minlength']">Mínimo 3 caracteres permitidos.</div>
          <div *ngIf="profileForm.controls['username']?.errors?.['maxlength']">Máximo 20 caracteres permitidos.</div>
        </div>
      </div>

      <!-- Nombre -->
      <div>
        <label class="block text-lg font-medium text-gray-700">Nombre *</label>
        <div class="flex items-center border border-gray-300 rounded-lg shadow-sm focus-within:ring-2 focus-within:ring-blue-500">
          <input
            type="text"
            [(ngModel)]="profile.name"
            name="name"
            required
            maxlength="100"
            class="outline-none text-lg w-full px-3 py-2 rounded-l-lg"
            placeholder="Nombre"
          />
          <i class="ti ti-id text-2xl px-3 text-gray-500"></i>
        </div>
        <div *ngIf="profileForm.controls['name']?.invalid && profileForm.controls['name']?.touched" class="text-red-500 text-sm mt-1">
          <div *ngIf="profileForm.controls['name']?.errors?.['required']">El nombre es obligatorio.</div>
          <div *ngIf="profileForm.controls['name']?.errors?.['maxlength']">Máximo 100 caracteres permitidos.</div>
        </div>
      </div>

      <!-- Apellidos -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-lg font-medium text-gray-700">Apellido Paterno *</label>
          <div class="flex items-center border border-gray-300 rounded-lg shadow-sm focus-within:ring-2 focus-within:ring-blue-500">
            <input
              type="text"
              [(ngModel)]="profile.paternalSurname"
              name="paternalSurname"
              required
              maxlength="100"
              class="outline-none text-lg w-full px-3 py-2 rounded-l-lg"
              placeholder="Apellido Paterno"
            />
            <i class="ti ti-id-badge text-2xl px-3 text-gray-500"></i>
          </div>
          <div *ngIf="profileForm.controls['paternalSurname']?.invalid && profileForm.controls['paternalSurname']?.touched" class="text-red-500 text-sm mt-1">
            Obligatorio (máximo 100 caracteres).
          </div>
        </div>
        <div>
          <label class="block text-lg font-medium text-gray-700">Apellido Materno *</label>
          <div class="flex items-center border border-gray-300 rounded-lg shadow-sm focus-within:ring-2 focus-within:ring-blue-500">
            <input
              type="text"
              [(ngModel)]="profile.maternalSurname"
              name="maternalSurname"
              required
              maxlength="100"
              class="outline-none text-lg w-full px-3 py-2 rounded-l-lg"
              placeholder="Apellido Materno"
            />
            <i class="ti ti-id-badge text-2xl px-3 text-gray-500"></i>
          </div>
          <div *ngIf="profileForm.controls['maternalSurname']?.invalid && profileForm.controls['maternalSurname']?.touched" class="text-red-500 text-sm mt-1">
            Obligatorio (máximo 100 caracteres).
          </div>
        </div>
      </div>

      <!-- DNI -->
      <div>
        <label class="block text-lg font-medium text-gray-700">DNI *</label>
        <div class="flex items-center border border-gray-300 rounded-lg shadow-sm focus-within:ring-2 focus-within:ring-blue-500">
          <input
            type="text"
            [(ngModel)]="profile.dni"
            name="dni"
            required
            pattern="\d{8}"
            class="outline-none text-lg w-full px-3 py-2 rounded-l-lg"
            placeholder="DNI"
          />
          <i class="ti ti-id text-2xl px-3 text-gray-500"></i>
        </div>
        <div *ngIf="profileForm.controls['dni']?.invalid && profileForm.controls['dni']?.touched" class="text-red-500 text-sm mt-1">
          <div *ngIf="profileForm.controls['dni']?.errors?.['required']">El DNI es obligatorio.</div>
          <div *ngIf="profileForm.controls['dni']?.errors?.['pattern']">Debe contener exactamente 8 números.</div>
        </div>
      </div>

      <!-- Teléfono -->
      <div>
        <label class="block text-lg font-medium text-gray-700">Teléfono *</label>
        <div class="flex items-center border border-gray-300 rounded-lg shadow-sm focus-within:ring-2 focus-within:ring-blue-500">
          <input
            type="text"
            [(ngModel)]="profile.phone"
            name="phone"
            required
            maxlength="9"
            pattern="\d{9}"
            class="outline-none text-lg w-full px-3 py-2 rounded-l-lg"
            placeholder="Teléfono"
          />
          <i class="ti ti-phone text-2xl px-3 text-gray-500"></i>
        </div>
        <div *ngIf="profileForm.controls['phone']?.invalid && profileForm.controls['phone']?.touched" class="text-red-500 text-sm mt-1">
          Debe ser un número válido de 9 dígitos.
        </div>
      </div>

      <!-- Dirección -->
      <div>
        <label class="block text-lg font-medium text-gray-700">Dirección</label>
        <div class="flex items-center border border-gray-300 rounded-lg shadow-sm focus-within:ring-2 focus-within:ring-blue-500">
          <input
            type="text"
            [(ngModel)]="profile.address"
            name="address"
            maxlength="100"
            class="outline-none text-lg w-full px-3 py-2 rounded-l-lg"
            placeholder="Dirección"
          />
          <i class="ti ti-map-pin text-2xl px-3 text-gray-500"></i>
        </div>
        <div *ngIf="profileForm.controls['address']?.invalid && profileForm.controls['address']?.touched" class="text-red-500 text-sm mt-1">
          <div *ngIf="profileForm.controls['address']?.errors?.['maxlength']">Máximo 100 caracteres permitidos.</div>
        </div>
      </div>

      <!-- Teléfono de respaldo -->
      <div>
        <label class="block text-lg font-medium text-gray-700">Teléfono de Respaldo</label>
        <div class="flex items-center border border-gray-300 rounded-lg shadow-sm focus-within:ring-2 focus-within:ring-blue-500">
          <input
            type="text"
            [(ngModel)]="profile.phoneBackup"
            name="phoneBackup"
            maxlength="9"
            pattern="\d{9}"
            class="outline-none text-lg w-full px-3 py-2 rounded-l-lg"
            placeholder="Teléfono Secundario"
          />
          <i class="ti ti-phone-plus text-2xl px-3 text-gray-500"></i>
        </div>
        <div *ngIf="profileForm.controls['phoneBackup']?.invalid && profileForm.controls['phoneBackup']?.touched" class="text-red-500 text-sm mt-1">
          <div *ngIf="profileForm.controls['phoneBackup']?.errors?.['pattern']">Debe contener exactamente 9 dígitos.</div>
        </div>
      </div>

      <!-- Fecha de Nacimiento -->
      <div>
        <label class="block text-lg font-medium text-gray-700">Fecha de Nacimiento</label>
        <div class="flex items-center border border-gray-300 rounded-lg shadow-sm focus-within:ring-2 focus-within:ring-blue-500">
          <input
            type="date"
            [(ngModel)]="profile.birthdate"
            name="birthdate"
            [max]="maxBirthdate"
            class="outline-none text-lg w-full px-3 py-2 rounded-l-lg"
          />
          <i class="ti ti-calendar text-2xl px-3 text-gray-500"></i>
        </div>
        <div *ngIf="profileForm.submitted && profileForm.controls['birthdate']?.errors?.['max']" class="text-red-500 text-sm">
          La fecha de nacimiento no debe ser posterior a hoy.
        </div>
      </div>

      <!-- Rol (Solo lectura) -->
      <div>
        <label class="block text-lg font-medium text-gray-700">Rol</label>
        <input
          type="text"
          [(ngModel)]="profile.role"
          name="role"
          readonly
          class="mt-1 block w-full px-4 py-2 border border-gray-300 bg-gray-100 rounded-lg focus:outline-none"
        />
      </div>


      <!-- Botones finales -->
      <div class="flex justify-end gap-4 mt-8">
        <button
          type="submit"
          class="bg-blue-600 text-white px-6 py-3 rounded-lg shadow hover:bg-blue-700 transition"
          [disabled]="profileForm.invalid || isSaving">
          Guardar Cambios
        </button>
        <button
          type="button"
          class="bg-red-500 text-white px-6 py-3 rounded-lg shadow hover:bg-red-600 transition"
          (click)="cancelUpdate()"
        >
          Cancelar
        </button>
      </div>
    </form>
  </div>

  <!-- Modal informativo tras actualización -->
  <div *ngIf="isReauthModalOpen" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
    <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-md">
      <h2 class="text-xl font-bold text-center mb-4">Actualización Exitosa</h2>
      <p class="text-gray-600 text-center mb-6">
        Tu perfil ha sido actualizado con éxito. Por seguridad, debes iniciar sesión nuevamente para continuar.
      </p>
      <div class="flex justify-center">
        <button
          type="button"
          class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition"
          (click)="navigateToLogin()">
          Ir al inicio de sesión
        </button>
      </div>
    </div>
  </div>

  <!-- Modal de confirmación para cancelar cambios -->
  <div
    *ngIf="isCancelModalOpen"
    class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50"
  >
    <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-md">
      <h2 class="text-xl font-bold text-center mb-4">Cancelar Cambios</h2>
      <p class="text-gray-600 text-center mb-6">
        ¿Estás seguro de que deseas cancelar los cambios? Serás redirigido a tu perfil y los cambios no se guardarán.
      </p>
      <div class="flex justify-between gap-4">
        <button
          (click)="confirmCancel()"
          class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition w-full"
        >
          Sí, cancelar
        </button>
        <button
          (click)="closeCancelModal()"
          class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition w-full"
        >
          No, volver
        </button>
      </div>
    </div>
  </div>
</section>

